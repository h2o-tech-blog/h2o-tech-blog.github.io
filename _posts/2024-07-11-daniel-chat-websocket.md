---
title: 채팅과 웹소켓 구조
author: Daniel
categories: [Blogging]
tags: [webSocket]
render_with_liquid: false
typora-root-url: ../
---

**Written by. Daniel**

## 채팅과 웹소켓

채팅 기능을 도입하기 위해서는 웹소켓 서버가 필수 불가결한 요소입니다. 하지만 단순히 “웹소켓 통신으로만” 채팅을 하게되면 백엔드에는 채팅을 했던 기록이 남지 않아 렌더링을 다시 하면 채팅을 했던 기록을 다시는 볼 수 없다는 큰 문제가 있습니다.

그렇다면 이를 해결하기 위해서는 “채팅을 DB에 저장을 하는 방법”이 있습니다. 채팅을 연결된 웹소켓 서버에 바로 전송하고 해당 웹소켓 서버에서 저장까지 하는 방법이 있습니다. 이 방법을 사용하게되면 이미 맺어진 웹소켓 커넥션을 통해 통신을 하는 것이기 때문에 속도면에 있어서는 탁월할 것이라 생각이 듭니다.
하지만 문제가 있는게 채팅 기능을 수정할 때마다 해당 웹소켓 서버를 다시 배포해야 하고, 그 때 해당 웹소켓에 연결되어 있는 세션이 끊기게 된다는 문제점이 있습니다. 그래서 다른 기능들을 해당 웹소켓 서버에 사용하기 힘들어서 확장성이 좋지 못하다는 점이 아쉽습니다.

위에서 얘기했던 방법은 “웹소켓으로만 채팅 주고 받기”, “웹소켓 서버에서 채팅 로그 DB에 저장하기”와 같은 방법을 제시했는데, ‘확장성 부족’, ‘채팅 로그 저장 안됨’, ‘세션 끊김’ 문제로 인해서 사용하기 약간 아쉬운 부분이 있습니다.
그래서 현재 프로젝트는 api 서버와 웹소켓 서버를 분리하여 “api 서버로 채팅을 전송하고, 해당 api 서버에서 웹소켓 서버로 채팅을 다시 전송”하는 방법을 채택하였습니다. 이 방법을 사용하게 되면 채팅 관련 기능을 수정해도 다른 곳에서 사용중인 웹소켓 세션이 끊길 일은 없고, 확장성을 좋게 가져갈 수 있습니다.

위의 글을 정리하자면 현재 생각나는 방법은 아래 세 가지가 있습니다.

- 웹소켓으로 단순히 채팅을 주고 받는다.
    - 문제점: 채팅 로그가 DB에 저장되지 않습니다.
- 웹소켓 서버에서 채팅 로그를 저장한다.
    - 문제점: 비즈니스 로직이 웹소켓 서버에 들어가기 때문에, 기능을 수정하고, 배포하려고 하면 현재 연결되어 있는 세션이 전부 끊기는 문제가 발생하며 확장성이 좋지 않습니다.
- api 서버와 웹소켓 서버 분리
    - **해당 방법 채택:** 위의 두 가지 방법에서 나타난 문제였던 “채팅 로그 DB 저장되지 않음”, “세션 끊김”, “확장성 부족”의 문제들을 api 서버에서 채팅 비즈니스 로직을 짜고, 웹소켓 서버는 단순 시그널 역할만하게 하여 해결할 수 있습니다.

## API 서버와 웹소켓 서버 분리

위의 여러 가지 이유들로 현재 프로젝트에서는 API 서버와 웹소켓 서버를 분리하여 사용하고 있습니다.
하지만 이 방법을 통해 프로젝트를 하면서 문제점을 발견하였습니다.

결국 웹소켓 서버와 API 서버간의 커넥션이 100% 확률로 맺어지는 것이 아니기 때문에 채팅이 DB에만 저장이 되고, 웹소켓은 발송이 되지 않아서 혼란을 야기시킬 수 있다는 문제점이 있었습니다. 특히 기존의 API 서버에서 웹소켓 서버와 커넥션을 맺는 방식은 API 요청이 들어올 때마다 요청별로 커넥션을 맺고, PUB을 한 후 커넥션을 다시 끊어버리는 방법을 사용하고 있었는데, 이 경우 여러 네트워크을 거치면서 “Connection TimeOut”이 뜨는 경우가 꽤 있었습니다.

그래서 데이터의 정합성이 잘 맞지 않는다는 문제가 발생했었는데, 이 문제를 해결할 방법으로 생각한 것이 API 요청별로 웹소켓 서버와 커넥션을 맺는 것이 아니라, 백엔드 서버는 미리 웹소켓 서버와 커넥션을 맺어두는 방식을 사용하는 것이었습니다. 그렇게 되면 커넥션을 굳이 매번 맺을 필요도 없고, 이미 웹소켓 서버와 연결이 되어 있으니 유실될 일도 적을 것이라고 판단하였습니다.
물론 이 방식도 문제가 있는게 중간에 분명히 커넥션이 끊길 경우가 있을텐데, 이 경우에 이를 API 서버에서 감지하지 못하면 API 서버를 다시 배포하지 않는 이상 영원히 커넥션이 끊겨 있을 수 있다는 문제가 있었습니다. 그런데 다행히도 커넥션이 끊기는 것을 감지하는 메서드를 지원하고 있어서 해당 메서드에 커넥션을 다시 맺는 로직을 추가하여 해당 문제를 방지하였습니다.

## 보완해야 할 점

현재는 급한대로 백엔드 서버와 웹소켓 서버간의 커넥션이 하나만 되어 있는데, 이렇게 되면 해당 커넥션에 문제가 생겼을 경우에 재연결을 맺긴 하겠지만, 그 연결을 맺는 시간 사이에 문제가 생길 수도 있고, 커넥션이 하나이다보니 API 서버에 트래픽이 몰렸을 때 해당 커넥션이 병목이 될 수도 있다는 문제가 있습니다.

그래서 추후에는 API 서버와 웹소켓 서버간에 커넥션을 여러 개 맺어두고, 이를 재사용하는 방식을 찾아서 도입할 예정입니다.